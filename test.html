<!DOCTYPE html>
<html>

<head>
  <title>Test img web manager</title>
</head>

<body>
  <div>
    <input type="file" id="imageInput" accept="image/*">
    <button onclick="uploadImage()">Upload image</button>
    <button onclick="deleteOnServer(room_id)">Delete room</button>
    <button onclick="deleteOnServer(room_id, chapter_id)">Delete chapter</button>
    <button
      onclick="deleteOnServer(room_id, chapter_id, document.getElementsByTagName('img')[0].getAttribute('data-img-name'))">Delete
      image</button>
  </div>
  <div></div>
  <div></div>
</body>
<script>
  const server = "127.0.0.1:8080"
  const room_id = "config-1";
  const chapter_id = "chapter-1";
  const socket = subscribeNotifications();
  readImageList();

  function readImageList() {
    fetch(`http://${server}/list/${room_id}/${chapter_id}`)
      .then((response) => {
        if (!response.ok) throw new Error(`Fehler beim Laden der Liste: ${response.status} - ${response.statusText}`);
        return response.json();
      }).then(data => {
        const divs = document.getElementsByTagName("div")
        for (const imgSrc of data) {
          const imgEl = document.createElement("img");
          imgEl.src = `http://${server}/img/${room_id}/${chapter_id}/${imgSrc}`;
          imgEl.setAttribute("data-img-name", imgSrc);
          imgEl.style = "float:left; max-width: 100%";
          if (imgSrc.includes("thumb")) divs[1].append(imgEl);
          else divs[2].append(imgEl);
        }
      })
  }

  async function readFile(file) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (ev) => resolve(ev.target?.result);
      reader.readAsDataURL(file);
    });
  }

  async function uploadImage() {
    const imageInput = document.getElementById('imageInput');
    const file = await readFile(imageInput.files[0])

    if (file == null) {
      alert('Bitte wähle ein Bild aus.');
      return;
    }

    fetch(`http://${server}/upload`, {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        room_id: room_id,
        chapter_id: chapter_id,
        image: file,
      }),
    })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Fehler beim Upload: ${response.status} - ${response.statusText}`);
        }
        console.log('Erfolgreich hochgeladen:', response.body);
      })
      .catch(error => console.error('Fehler:', error));
  }

  function subscribeNotifications() {
    // WebSocket-Verbindung aufbauen
    const socket = new WebSocket(`ws://${server}/ws/${room_id}`);

    // Eventlistener für Verbindungsöffnen
    socket.addEventListener('open', (event) => {
      console.log('WebSocket-Verbindung geöffnet:', event);
    });

    // Eventlistener für Verbindungsfehler
    socket.addEventListener('error', (event) => {
      console.error('Fehler bei der WebSocket-Verbindung:', event);
    });

    // Eventlistener für Verbindungsabbrechen
    socket.addEventListener('close', (event) => {
      console.log('WebSocket-Verbindung geschlossen:', event);
    });
    return socket;
  }

  function deleteOnServer(roomId, chapterId, imgName) {
    let url = `http://${server}/delete/${roomId}`
    if (chapterId) url += `/${chapterId}`
    if (imgName) url += `/${imgName}`
    fetch(url, {
      method: "POST",
    }).catch(err => console.error(err))
  }
</script>

</html>