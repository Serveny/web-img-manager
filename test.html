<!DOCTYPE html>
<html>

<head>
  <title>Test img web manager</title>
</head>

<body>
  <div>
    <input type="file" id="imageInput" accept="image/*">
    <input type="text" id="chapterIdInput" placeholder="Chapter ID">
    <button onclick="uploadImage()">Bild hochladen</button>
  </div>
  <div></div>
  <div></div>
</body>
<script>
  const server = "http://127.0.0.1:8080"
  const config_id = "config-1";
  const chapter_id = "chapter-1";
  readImageList();

  function readImageList() {
    fetch(`${server}/list/${config_id}/${chapter_id}`)
      .then((response) => {
        if (!response.ok) throw new Error(`Fehler beim Laden der Liste: ${response.status} - ${response.statusText}`);
        return response.json();
      }).then(data => {
        const divs = document.getElementsByTagName("div")
        for (const imgSrc of data) {
          const imgEl = document.createElement("img");
          imgEl.src = `${server}/img/${config_id}/${chapter_id}/${imgSrc}`;
          imgEl.style = "float:left; max-width: 100%";
          if (imgSrc.includes("thumb")) divs[1].append(imgEl);
          else divs[2].append(imgEl);
        }
      })
  }

  async function readFile(file) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (ev) => resolve(ev.target?.result);
      reader.readAsDataURL(file);
    });
  }

  async function uploadImage() {
    const imageInput = document.getElementById('imageInput');

    const file = await readFile(imageInput.files[0])
    const chapterId = chapterIdInput.value;

    if (file == null) {
      alert('Bitte wÃ¤hle ein Bild aus und gib eine Chapter ID ein.');
      return;
    }

    fetch('http://127.0.0.1:8080/upload', {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        config_id: config_id,
        chapter_id: chapter_id,
        image: file,
      }),
    })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Fehler beim Upload: ${response.status} - ${response.statusText}`);
        }
        return null;
      })
      .then(data => {
        console.log('Erfolgreich hochgeladen:', data);
      })
      .catch(error => {
        console.error('Fehler:', error);
      });
  }
</script>

</html>